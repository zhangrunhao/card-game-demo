# DEV.md

## 目标
实现 Demo2 后端逻辑（参考 `backend/projects/20250120_card-game01.js` 的结构），但不影响 Demo1 运行。

## 基础规则
- 每位玩家固定牌组 15 张：A×5 / D×5 / R×5
- 初始血量 10，血量无上限，最低可到 0
- 总回合 10 回合；任一方血量 ≤ 0 立即结束，否则第 10 回合后比血量

## 端点与连接（建议）
- HTTP Health: `/api/20250126-card_game02/health`
- WebSocket: `/api/20250126-card_game02/ws`

## 房间与状态模型（建议）
### Room
- `roomId`
- `status`: `waiting | playing | finished`
- `round`: 1..10
- `players`: `[p1, p2]`
- `actions`: 记录本回合玩家提交的“3 张序列”
- `botTimeout`: 可选，用于 AI 延迟出牌

### Player
- `playerId`
- `name`
- `hp`
- `deck`: 牌库（数组，元素为 `A/D/R`）
- `discard`: 弃牌堆
- `hand`: 本回合抽到的 5 张（仅保存在服务端）
- `isBot`

## 回合流程（服务端主导）
1. **发牌**：双方从各自 `deck` 抽 5（不足则洗 `discard` 回 `deck` 继续抽）。
2. **发手牌**：仅将各自的 5 张发给对应客户端。
3. **收取提交**：客户端提交 3 张序列（建议提交为索引或牌值数组）。
4. **同时揭示**：服务端广播双方 3 张序列。
5. **结算 3 次对冲**：依次结算并累计 HP 变化。
6. **弃置**：本回合抽到的 5 张全部进入 `discard`。
7. **回合推进**：判断结束条件；否则 `round + 1` 并进入下一回合。

## 牌库不足处理
- 抽牌时若 `deck` 不足 5：先抽完，再将 `discard` 洗回 `deck` 继续抽。
- 若 `discard` 为空，则按实际数量抽（允许本回合少于 5 张）。

## 对冲结算矩阵
以 `A/D/R` 映射 `attack/defend/rest`，单次对冲变化如下：
- A vs A：双方 -2
- A vs D：双方 0
- A vs R：A 0 / R -2
- D vs A：双方 0
- D vs D：双方 0
- D vs R：D 0 / R +1
- R vs A：R -2 / A 0
- R vs D：R +1 / D 0
- R vs R：双方 +1

## AI（可选）
- 机器人在手牌 5 张中随机选 3 张，随机排序。
- 可延迟 1~3 秒提交，模拟真人节奏。

## WebSocket 消息（建议）
### client -> server
- `create_room` / `join_room`：同 Demo1 的字段结构。
- `play_cards`：提交 3 张序列
  - `payload`: `{ roomId, playerId, round, picks }`
  - `picks` 建议为数组（长度 3），可为手牌索引或牌值（需后端校验合法性）。

### server -> client
- `room_state`: 同 Demo1 结构（包含 round、hp、已提交状态）。
- `round_hand`: `{ roomId, round, hand }`（仅发送给对应玩家）。
- `round_reveal`: `{ roomId, round, p1: [..], p2: [..] }`
- `round_result`:
  - `{ roomId, round, steps: [{ p1Card, p2Card, p1Delta, p2Delta }], p1Hp, p2Hp }`
- `game_over`: `{ roomId, round, result, final }`
- `error`: `{ message }`

## 关键校验点
- 提交的 3 张必须来自本回合 `hand`，且数量正确，且不可重复超出手牌数量。
- 只有本回合玩家可提交一次。
- 结算时使用服务端权威牌序，防止客户端作弊。

## 注意事项
- 不修改 `20250120_card-game01` 相关逻辑与注册。
- Demo2 的注册与路由在独立文件中实现，必要时在 `backend/server.js` 额外注册（若要启用）。
